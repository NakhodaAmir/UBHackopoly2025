<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Screen (Step-by-Step Demo)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #1a1a2e; color: #e0e0e0; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .battle-screen { width: 95%; max-width: 1400px; border: 2px solid #00e5ff; border-radius: 15px; background-color: #1f2a40; box-shadow: 0 0 30px rgba(0, 229, 255, 0.4); overflow: hidden; display: flex; flex-direction: column; }
        .battle-header { display: flex; justify-content: space-between; padding: 20px; background-color: rgba(0, 0, 0, 0.3); border-bottom: 1px solid #00e5ff; }
        .stats-block { width: 30%; background: rgba(10, 20, 40, 0.5); padding: 15px; border-radius: 8px; }
        .stats-block h2 { margin: 0 0 10px; color: #00e5ff; font-family: 'Press Start 2P', cursive; font-size: 16px; }
        .stats-block p { margin: 5px 0; font-size: 14px; }
        .stat-bar { width: 100%; background-color: #111; border-radius: 5px; overflow: hidden; height: 15px; border: 1px solid #555; }
        .hp-bar { background-color: #d90000; height: 100%; transition: width 0.5s ease; }
        .ap-bar { background-color: #007bff; height: 100%; transition: width 0.5s ease; }
        .battle-main { display: flex; padding: 20px; gap: 20px; }
        .action-palette { flex-basis: 15%; display: flex; flex-direction: column; gap: 10px; }
        .action-block { padding: 15px 10px; font-size: 1em; font-weight: bold; background-color: #3b4b6b; border: 2px solid #5a6b8b; color: #fff; border-radius: 5px; cursor: move; text-align: left; display: flex; align-items: center; gap: 10px; transition: background-color 0.2s, border-color 0.2s, opacity 0.2s; }
        .action-block:hover { background-color: #4c5d7e; border-color: #00e5ff; }
        .action-block span { font-size: 1.2em; }
        .dragging { opacity: 0.5; border-style: dashed; }
        .center-area { flex-basis: 60%; display: flex; flex-direction: column; gap: 15px; }
        .character-area { display: flex; justify-content: space-around; align-items: center; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; }
        .character-sprite { width: 100px; height: 100px; background-color: #334; border: 2px dashed #556; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-style: italic; color: #889; }
        .vs-graphic { font-size: 2.5em; font-weight: bold; color: #00e5ff; font-family: 'Press Start 2P', cursive; }
        .battle-log { height: 120px; background-color: rgba(0, 0, 0, 0.5); border: 1px solid #445; border-radius: 5px; padding: 15px; overflow-y: auto; color: #ccc; }
        .battle-log p { margin: 2px 0; }
        .battle-log .player-action { color: #00e5ff; font-weight: bold; }
        .battle-log .enemy-action { color: #ff4d4d; font-weight: bold; }
        .battle-log .system-message { color: #b3a400; font-style: italic; }
        .program-slots { display: flex; flex-direction: column; gap: 10px; }
        .slot { background-color: rgba(0, 0, 0, 0.3); border: 1px solid #445; border-radius: 8px; padding: 15px; }
        .slot h3 { margin: 0 0 10px; color: #aaa; }
        .drop-zone { min-height: 70px; background-color: rgba(0, 0, 0, 0.4); border: 2px dashed #00e5ff; border-radius: 5px; padding: 10px; display: flex; flex-direction: column; gap: 5px; color: #777; font-style: italic; justify-content: center; align-items: center; transition: background-color 0.3s, border-color 0.3s; }
        .drag-over { background-color: rgba(0, 229, 255, 0.2); border-color: #fff; }
        .dropped-block { padding: 10px; border-radius: 5px; color: white; font-family: 'Courier New', Courier, monospace; font-weight: bold; display: flex; align-items: center; gap: 8px; font-style: normal; width: 90%; justify-content: center; }
        .attack-block { background-color: #b32d00; }
        .charge-block { background-color: #d97400; }
        .heal-block { background-color: #006ddb; }
        .defend-block { background-color: #005a8a; }
        .counter-block { background-color: #8a00b3; }
        .focus-block { background-color: #ffffff; color: #1a1a2e; }
        .cleanse-block { background-color: #4dfc00; color: #1a1a2e; }
        .info-sidebar { flex-basis: 25%; padding: 15px; background-color: rgba(0, 0, 0, 0.3); border-radius: 8px; border: 1px solid #445; }
        .info-sidebar h3 { margin: 0 0 10px; color: #00e5ff; font-family: 'Press Start 2P', cursive; font-size: 14px; }
        .buff-list { list-style: none; padding: 0; }
        .buff-list li { background: #3b4b6b; padding: 8px; border-radius: 4px; margin-bottom: 5px; }
        .debuff { background: #b32d00; color: white; }
        .battle-footer { text-align: center; padding: 20px; background-color: rgba(0, 0, 0, 0.3); border-top: 1px solid #00e5ff; }
        .execute-button { padding: 15px 40px; font-size: 1.3em; background-color: #00e5ff; color: #1a1a2e; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .execute-button:hover { background-color: #fff; box-shadow: 0 0 15px #00e5ff; }
        .execute-button:disabled { background-color: #555; color: #999; cursor: not-allowed; }

        /* --- ‚òÖ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„Çø„Ç§„É´ ‚òÖ --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1f2a40;
            border: 2px solid #00e5ff;
            border-radius: 10px;
            padding: 30px;
            width: 80%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
        }
        .modal-content p {
            font-size: 1.2em;
            margin: 0 0 20px;
            line-height: 1.6;
        }
        .modal-button {
            padding: 10px 30px;
            font-size: 1em;
            background-color: #00e5ff;
            color: #1a1a2e;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="battle-screen">
        
        <header class="battle-header">
            <div class="stats-block" id="player-stats-block">
                <h2>Player Hero</h2>
                <p id="player-hp-text">HP: 400 / 400</p>
                <div class="stat-bar"><div class="hp-bar" id="player-hp-bar" style="width: 100%;"></div></div>
                <p id="player-ap-text">AP: 8 / 8</p>
                <div class="stat-bar"><div class="ap-bar" id="player-ap-bar" style="width: 100%;"></div></div>
            </div>
            
            <div class="stats-block" id="enemy-stats-block">
                <h2>Enemy AI (L1)</h2>
                <p id="enemy-hp-text">HP: 300 / 300</p>
                <div class="stat-bar"><div class="hp-bar" id="enemy-hp-bar" style="width: 100%;"></div></div>
                <p id="enemy-ap-text">AP: 8 / 8</p>
                <div class="stat-bar"><div class="ap-bar" id="enemy-ap-bar" style="width: 100%;"></div></div>
            </div>
        </header>

        <main class="battle-main">
            <aside class="action-palette">
                <button class="action-block" data-action="ATTACK" draggable="true"><span>‚öîÔ∏è</span> ATTACK (2)</button>
                <button class="action-block" data-action="CHARGE" draggable="true"><span>‚ö°</span> CHARGE (1)</button>
                <button class="action-block" data-action="HEAL" draggable="true"><span>‚úö</span> HEAL (4)</button>
                <button class="action-block" data-action="DEFEND" draggable="true"><span>üõ°Ô∏è</span> DEFEND (2)</button>
                <button class="action-block" data-action="COUNTER" draggable="true"><span>üîÑ</span> COUNTER (3)</button>
                <button class="action-block cleanse-block" data-action="CLEANSE" draggable="true"><span>‚ú®</span> CLEANSE (4)</button>
                <button class="action-block focus-block" data-action="FOCUS" draggable="true"><span>üßò</span> FOCUS (0)</button>
            </aside>

            <div class="center-area">
                <div class="character-area">
                    <div class="character-sprite">[Player Sprite]</div>
                    <div class="vs-graphic">VS</div>
                    <div class="character-sprite">[Enemy Sprite]</div>
                </div>

                <div class="battle-log" id="battle-log">
                    <p class="system-message">System ready. Drag 4 actions to the slots.</p>
                </div>

                <div class="program-slots">
                    <div class="slot" id="slot-1"><div class="drop-zone" data-slot-id="1">[1st Action]</div></div>
                    <div class="slot" id="slot-2"><div class="drop-zone" data-slot-id="2">[2nd Action]</div></div>
                    <div class="slot" id="slot-3"><div class="drop-zone" data-slot-id="3">[3rd Action]</div></div>
                    <div class="slot" id="slot-4"><div class="drop-zone" data-slot-id="4">[4th Action]</div></div>
                </div>
            </div>

            <aside class="info-sidebar">
                <h3>Player Buffs/Debuffs</h3>
                <ul class="buff-list" id="player-buff-list">
                    <li>(No active effects)</li>
                </ul>
                <h3>Enemy Buffs/Debuffs</h3>
                <ul class="buff-list" id="enemy-buff-list">
                    <li>(No active effects)</li>
                </ul>
            </aside>
        </main>

        <footer class="battle-footer">
            <button class="execute-button" id="execute-turn">EXECUTE TURN</button>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. ÂÜÖÈÉ®„Éá„Éº„Çø („Ç≤„Éº„É†„Çπ„ÉÜ„Éº„Éà) ---
            const logicSlots = { "1": null, "2": null, "3": null, "4": null };
            let isBattleOver = false;

            const player = {
                name: "Player",
                maxHp: 400,
                currentHp: 400,
                attack: 70,
                speed: 70,
                maxAp: 8,
                currentAp: 8,
                chargeTurns: 0,
                isDefending: false,
                isCountering: false,
                isPoisoned: true, // „Éá„É¢Áî®„Å´ÊúÄÂàù„Åã„ÇâPoisoned
                isStunned: false
            };
            
            const enemy = {
                name: "Enemy L1",
                maxHp: 300,
                currentHp: 300,
                attack: 100, 
                speed: 60,
                maxAp: 8,
                currentAp: 8,
                chargeTurns: 0,
                isDefending: false,
                isCountering: false,
                isPoisoned: false,
                isStunned: false
            };

            const ACTIONS = {
                "ATTACK": { cost: 2, bonus: 10 },
                "CHARGE": { cost: 1, percent: 0.20, turns: 3 },
                "HEAL": { cost: 4, amount: 100 },
                "DEFEND": { cost: 2, reduction: 0.80 },
                "COUNTER": { cost: 3, multiplier: 1.5, penalty: 0.20 },
                "CLEANSE": { cost: 4 },
                "FOCUS": { cost: 0, amount: 4 }
            };
            
            const MAX_AP = 8;
            const AP_RECOVERY = 4;

            // --- 2. HTMLË¶ÅÁ¥†„ÅÆÂèñÂæó ---
            const executeButton = document.getElementById('execute-turn');
            const actionPaletteButtons = document.querySelectorAll('.action-palette .action-block');
            const dropZones = document.querySelectorAll('.drop-zone');
            const battleLog = document.getElementById('battle-log');
            const playerHpText = document.getElementById('player-hp-text');
            const playerHpBar = document.getElementById('player-hp-bar');
            const playerApText = document.getElementById('player-ap-text');
            const playerApBar = document.getElementById('player-ap-bar');
            const enemyHpText = document.getElementById('enemy-hp-text');
            const enemyHpBar = document.getElementById('enemy-hp-bar');
            const enemyApText = document.getElementById('enemy-ap-text');
            const enemyApBar = document.getElementById('enemy-ap-bar');
            const playerBuffList = document.getElementById('player-buff-list');

            // --- 3. Ë£úÂä©Èñ¢Êï∞ ---
            
            /**
             * ‚òÖ Êñ∞Ê©üËÉΩÔºö„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÔºà„É¢„Éº„ÉÄ„É´ÔºâË°®Á§∫Èñ¢Êï∞ ‚òÖ
             * @param {string} message - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Å´Ë°®Á§∫„Åô„Çã„É°„ÉÉ„Çª„Éº„Ç∏
             * @returns {Promise<void>} - „É¶„Éº„Ç∂„Éº„Åå "OK" „ÇíÊäº„Åô„Å®Ëß£Ê±∫„Åô„ÇãPromise
             */
            function showActionPopup(message) {
                // Promise„ÇíËøî„Åó„ÄÅ"OK"„ÅåÊäº„Åï„Çå„Çã„Åæ„Åß await „ÅßÂæÖÊ©ü„Åï„Åõ„Çã
                return new Promise(resolve => {
                    // „Ç™„Éº„Éê„Éº„É¨„Ç§„Çí‰ΩúÊàê
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';

                    // „É¢„Éº„ÉÄ„É´„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩúÊàê
                    const modal = document.createElement('div');
                    modal.className = 'modal-content';
                    
                    const text = document.createElement('p');
                    text.innerHTML = message; // HTML„Çø„Ç∞„ÇíË®±ÂèØ
                    
                    const okButton = document.createElement('button');
                    okButton.className = 'modal-button';
                    okButton.textContent = 'OK';

                    modal.appendChild(text);
                    modal.appendChild(okButton);
                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);

                    // "OK" „Éú„Çø„É≥„ÅåÊäº„Åï„Çå„Åü„Çâ...
                    okButton.onclick = () => {
                        document.body.removeChild(overlay); // „É¢„Éº„ÉÄ„É´„ÇíÂâäÈô§
                        resolve(); // Promise„ÇíËß£Ê±∫„Åó„Å¶„Ç≤„Éº„É†„É´„Éº„Éó„ÇíÂÜçÈñã
                    };
                });
            }
            
            function logToScreen(message, type = 'system') {
                if (!battleLog) return;
                const p = document.createElement('p');
                p.textContent = message;
                p.className = `${type}-message`;
                battleLog.appendChild(p);
                battleLog.scrollTop = battleLog.scrollHeight;
            }

            function updateUI() {
                player.currentHp = Math.max(0, player.currentHp);
                playerHpText.textContent = `HP: ${player.currentHp} / ${player.maxHp}`;
                playerHpBar.style.width = `${(player.currentHp / player.maxHp) * 100}%`;
                playerApText.textContent = `AP: ${player.currentAp} / ${player.maxAp}`;
                playerApBar.style.width = `${(player.currentAp / player.maxAp) * 100}%`;

                enemy.currentHp = Math.max(0, enemy.currentHp);
                enemyHpText.textContent = `HP: ${enemy.currentHp} / ${enemy.maxHp}`;
                enemyHpBar.style.width = `${(enemy.currentHp / enemy.maxHp) * 100}%`;
                enemyApText.textContent = `AP: ${enemy.currentAp} / ${enemy.maxAp}`;
                enemyApBar.style.width = `${(enemy.currentAp / enemy.maxAp) * 100}%`;
                
                playerBuffList.innerHTML = ''; 
                if (player.chargeTurns > 0) {
                    playerBuffList.innerHTML += `<li>ATK UP - ${player.chargeTurns} Turns remaining</li>`;
                }
                if (player.isPoisoned) {
                    playerBuffList.innerHTML += `<li class="debuff">POISONED</li>`;
                }
                if (player.isStunned) {
                    playerBuffList.innerHTML += `<li class="debuff">STUNNED</li>`;
                }
                if (!playerBuffList.innerHTML) {
                    playerBuffList.innerHTML = `<li>(No active effects)</li>`;
                }
            }

            function resetSlots() {
                dropZones.forEach(zone => {
                    zone.innerHTML = `[${zone.dataset.slotId}st Action]`;
                    logicSlots[zone.dataset.slotId] = null;
                });
            }

            // --- 4. „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„É≠„Ç∏„ÉÉ„ÇØ ---
            actionPaletteButtons.forEach(block => {
                block.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', block.dataset.action);
                    block.classList.add('dragging');
                });
                block.addEventListener('dragend', () => block.classList.remove('dragging'));
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    const actionName = e.dataTransfer.getData('text/plain');
                    const slotId = zone.dataset.slotId;
                    logicSlots[slotId] = actionName; 
                    
                    zone.innerHTML = '';
                    const droppedBlock = document.createElement('div');
                    let styleClass = actionName.toLowerCase() + '-block';
                    droppedBlock.className = `dropped-block ${styleClass}`;
                    droppedBlock.textContent = actionName;
                    zone.appendChild(droppedBlock);
                });
            });

            // --- 5. ÊïµAI„É≠„Ç∏„ÉÉ„ÇØ (L1 ÊîªÊíÉÂûã) ---
            function getEnemyAction() {
                if (enemy.currentHp < enemy.maxHp * 0.5 && enemy.currentAp >= ACTIONS.HEAL.cost) {
                    return "HEAL"; 
                }
                if (enemy.currentAp >= ACTIONS.ATTACK.cost) {
                    return "ATTACK"; 
                }
                return "FOCUS";
            }

            // --- 6. ÂÆüË°å„Éú„Çø„É≥ („É°„Ç§„É≥„Ç≤„Éº„É†„É´„Éº„Éó) ---
            executeButton.addEventListener('click', async () => {
                if (isBattleOver) {
                    alert("Battle is over. Please refresh to restart.");
                    return;
                }
                if (Object.values(logicSlots).some(action => action === null)) {
                    alert("Please fill all 4 action slots before executing.");
                    return;
                }

                executeButton.disabled = true;
                logToScreen("--- TURN START ---", 'system');

                // 4ÂõûË°åÂãï„É´„Éº„Éó
                for (let i = 1; i <= 4; i++) {
                    if (isBattleOver) break;

                    const playerAction = logicSlots[i];
                    const enemyAction = getEnemyAction(); 

                    const playerGoesFirst = player.speed >= enemy.speed;
                    
                    const actionsInOrder = playerGoesFirst 
                        ? [{ actor: player, action: playerAction, target: enemy, name: "Player" },
                           { actor: enemy, action: enemyAction, target: player, name: "Enemy" }]
                        : [{ actor: enemy, action: enemyAction, target: player, name: "Enemy" },
                           { actor: player, action: playerAction, target: enemy, name: "Player" }];

                    // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆÂÆüË°åÔºà2ÂõûÔºö„Éó„É¨„Ç§„É§„Éº„Å®ÊïµÔºâ
                    for (const turn of actionsInOrder) {
                        if (isBattleOver) break;
                        // ‚òÖ Â§âÊõ¥ÁÇπÔºöprocessAction„ÅåÂÆå‰∫Ü„Åô„ÇãÔºà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåÊäº„Åï„Çå„ÇãÔºâ„Åæ„ÅßÂæÖÊ©ü
                        await processAction(turn.actor, turn.target, turn.action, turn.name);
                    }
                }

                if (!isBattleOver) {
                    await endTurn(); // „Çø„Éº„É≥ÁµÇ‰∫ÜÂá¶ÁêÜ„ÇÇ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÂá∫„Åô„Åü„ÇÅÂæÖÊ©ü
                    logToScreen("--- WAITING FOR NEXT 4 ACTIONS ---", 'system');
                    executeButton.disabled = false;
                    resetSlots();
                }
            });

            // --- 7. „Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆüË°å„É≠„Ç∏„ÉÉ„ÇØ (Ë©≥Á¥∞) ---
            async function processAction(actor, target, action, actorName) {
                if (actor.currentHp <= 0) return; 

                // STUN„ÉÅ„Çß„ÉÉ„ÇØ
                if (actor.isStunned) {
                    actor.isStunned = false; // È∫ªÁó∫„ÅØ1„Çø„Éº„É≥„ÅßËß£Èô§
                    updateUI();
                    await showActionPopup(`<strong>${actorName} is STUNNED</strong> and cannot act!`);
                    return;
                }

                const actionSpec = ACTIONS[action];
                if (!actionSpec) {
                    await showActionPopup(`${actorName} skipped action.`);
                    return;
                }

                if (actor.currentAp < actionSpec.cost) {
                    await showActionPopup(`${actorName} failed ${action} (Not enough AP)`);
                    return;
                }
                actor.currentAp -= actionSpec.cost;

                let logMessage = `<strong>${actorName}</strong> used <strong>${action}</strong>. `;
                
                // „Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆüË°å
                switch(action) {
                    case "ATTACK":
                        let damage = actor.attack + actionSpec.bonus;
                        if (actor.chargeTurns > 0) {
                            damage *= (1 + ACTIONS.CHARGE.percent);
                        }
                        damage = Math.floor(damage);
                        
                        if (target.isDefending) {
                            damage = Math.floor(damage * (1 - ACTIONS.DEFEND.reduction)); 
                            logMessage += `${target.name} DEFENDED! `;
                        } else if (target.isCountering) {
                            const counterDamage = Math.floor(damage * ACTIONS.COUNTER.multiplier);
                            actor.currentHp -= counterDamage;
                            logMessage += `${target.name} COUNTERED! ${actorName} takes ${counterDamage} damage! `;
                            damage = 0;
                        }
                        
                        target.currentHp -= damage;
                        logMessage += `Dealt ${damage} damage.`;
                        break;
                    
                    case "CHARGE":
                        actor.chargeTurns = actionSpec.turns;
                        logMessage += `ATK UP for 3 turns.`;
                        break;
                        
                    case "HEAL":
                        actor.currentHp = Math.min(actor.maxHp, actor.currentHp + actionSpec.amount);
                        logMessage += `Healed ${actionSpec.amount} HP.`;
                        break;
                        
                    case "DEFEND":
                        actor.isDefending = true; 
                        logMessage += `Prepares to defend.`;
                        break;
                    
                    case "COUNTER":
                        actor.isCountering = true;
                        // Â§±ÊïóÊôÇ„ÅÆ„Éö„Éä„É´„ÉÜ„Ç£„ÅØ„ÄÅÁõ∏Êâã„ÅåÊîªÊíÉ„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„Å´Áô∫Áîü
                        if ((actorName === 'Player' && getEnemyAction() !== 'ATTACK') || 
                            (actorName === 'Enemy' && logicSlots[Object.keys(logicSlots).find(k => logicSlots[k])] !== 'ATTACK')) { // Á∞°ÊòìÁöÑ„Å™Áõ∏Êâã„ÅÆË°åÂãï‰∫àÊ∏¨
                             const penalty = Math.floor(actor.maxHp * ACTIONS.COUNTER.penalty);
                             actor.currentHp -= penalty;
                             logMessage += `FAILED COUNTER! Takes ${penalty} self-damage.`;
                        } else {
                            logMessage += `Prepares to counter.`;
                        }
                        break;
                    
                    case "CLEANSE":
                        actor.isPoisoned = false;
                        actor.isStunned = false;
                        logMessage += `Status normalized.`;
                        break;
                    
                    case "FOCUS":
                        actor.currentAp = Math.min(actor.maxAp, actor.currentAp + actionSpec.amount);
                        logMessage += `Recovered ${actionSpec.amount} AP.`;
                        break;
                }
                
                if (actorName === 'Player') {
                    enemy.isDefending = false;
                    enemy.isCountering = false;
                } else {
                    player.isDefending = false;
                    player.isCountering = false;
                }

                // ‚òÖ Â§âÊõ¥ÁÇπÔºö„É≠„Ç∞„Çí„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅßË°®Á§∫„Åó„ÄÅUI„ÇíÊõ¥Êñ∞
                await showActionPopup(logMessage);
                logToScreen(logMessage.replace(/<[^>]*>/g, ''), actorName === 'Player' ? 'player' : 'enemy'); // „É≠„Ç∞„Å´„ÇÇË®òÈå≤
                updateUI();
                checkWinCondition();
            }
            
            // --- 8. „Çø„Éº„É≥ÁµÇ‰∫ÜÂá¶ÁêÜ ---
            async function endTurn() {
                let turnEndMessage = "--- End of Turn ---<br>";
                
                // APÂõûÂæ©
                player.currentAp = Math.min(MAX_AP, player.currentAp + AP_RECOVERY);
                enemy.currentAp = Math.min(MAX_AP, enemy.currentAp + AP_RECOVERY);
                turnEndMessage += `AP recovered (+${AP_RECOVERY}).<br>`;
                
                // „Éê„Éï„Çø„Éº„É≥Ê∏õÂ∞ë
                if (player.chargeTurns > 0) player.chargeTurns--;
                if (enemy.chargeTurns > 0) enemy.chargeTurns--;
                
                // ÊØí„ÉÄ„É°„Éº„Ç∏
                if (player.isPoisoned) {
                    const poisonDmg = Math.floor(player.maxHp * 0.05); // 5%
                    player.currentHp -= poisonDmg;
                    turnEndMessage += `Player takes ${poisonDmg} poison damage.<br>`;
                }
                
                await showActionPopup(turnEndMessage); // „Çø„Éº„É≥ÁµÇ‰∫ÜÊôÇ„Å´„ÇÇ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó
                logToScreen("Turn ended. AP and effects processed.", "system");
                
                updateUI();
                checkWinCondition();
            }

            // --- 9. ÂãùÊïóÂà§ÂÆö ---
            function checkWinCondition() {
                if (isBattleOver) return;
                
                if (enemy.currentHp <= 0) {
                    showActionPopup("--- üéâ YOU WIN! üéâ ---");
                    logToScreen("--- YOU WIN! ---", 'system');
                    isBattleOver = true;
                    executeButton.disabled = true;
                } else if (player.currentHp <= 0) {
                    showActionPopup("--- ‚ò†Ô∏è YOU LOSE... ‚ò†Ô∏è ---");
                    logToScreen("--- YOU LOSE... ---", 'enemy-action');
                    isBattleOver = true;
                    executeButton.disabled = true;
                }
            }

            // ÂàùÊúüUIÊõ¥Êñ∞
            updateUI();
        });
    </script>

</body>
</html>
